# 데이터베이스 마이그레이션 가이드

## 개요

`work_records` 테이블에 `notes` 컬럼을 추가하는 마이그레이션입니다.

## 방법 1: 자동 마이그레이션 (권장)

서버를 시작하면 자동으로 마이그레이션이 실행됩니다. `main.py`에서 자동으로 처리합니다.

```bash
# 서버 시작 시 자동으로 마이그레이션 실행됨
python main.py
# 또는
uvicorn main:app --reload
```

## 방법 2: 수동 마이그레이션

별도로 마이그레이션 스크립트를 실행할 수 있습니다.

### Windows
```bash
cd backend
migrate.bat
```

### Linux/macOS
```bash
cd backend
chmod +x migrate.sh
./migrate.sh
```

### Python 직접 실행
```bash
cd backend
python -m app.migrations
```

## 방법 3: SQLite 직접 수정

SQLite 데이터베이스 파일에 직접 접근하여 수정할 수 있습니다.

### SQLite CLI 사용
```bash
sqlite3 test.db
```

SQLite 프롬프트에서:
```sql
-- 컬럼 존재 여부 확인
PRAGMA table_info(work_records);

-- notes 컬럼 추가 (없는 경우만)
ALTER TABLE work_records ADD COLUMN notes VARCHAR(1000);

-- 확인
PRAGMA table_info(work_records);
.exit
```

### Python 스크립트 사용
```python
import sqlite3

conn = sqlite3.connect('test.db')
cursor = conn.cursor()

# 컬럼 추가
cursor.execute("ALTER TABLE work_records ADD COLUMN notes VARCHAR(1000)")

conn.commit()
conn.close()
```

## 방법 4: 개발 환경 - 데이터베이스 재생성

**주의: 기존 데이터가 모두 삭제됩니다!**

개발 환경에서 테스트 데이터가 중요하지 않다면, 데이터베이스 파일을 삭제하고 서버를 재시작하면 됩니다.

### Windows
```bash
del test.db
python main.py
```

### Linux/macOS
```bash
rm test.db
python main.py
```

## 마이그레이션 확인

마이그레이션이 성공적으로 완료되었는지 확인하려면:

### 방법 1: API 테스트
```bash
# 공수 기록 생성 시 notes 필드가 포함되는지 확인
curl -X POST http://localhost:8000/work-records \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "worker_id": "test",
    "worker_name": "테스트",
    "site_name": "현장1",
    "work_date": "2025-01-01",
    "work_hours": 8.0,
    "notes": "테스트 비고",
    "team_id": "team1",
    "created_by": "admin"
  }'
```

### 방법 2: SQLite 직접 확인
```bash
sqlite3 test.db
```

```sql
SELECT id, worker_name, site_name, notes FROM work_records LIMIT 5;
```

## 문제 해결

### 오류: "duplicate column name: notes"
- 이미 컬럼이 존재합니다. 마이그레이션이 완료된 상태입니다.

### 오류: "no such table: work_records"
- 테이블이 아직 생성되지 않았습니다. 서버를 한 번 실행하면 자동으로 생성됩니다.

### 오류: "database is locked"
- 다른 프로세스가 데이터베이스를 사용 중입니다. 서버를 중지하고 다시 시도하세요.

## 참고사항

- SQLite는 컬럼 삭제나 타입 변경을 지원하지 않습니다.
- 컬럼 추가는 안전하며 기존 데이터에 영향을 주지 않습니다.
- 프로덕션 환경에서는 데이터베이스 백업을 먼저 수행하는 것을 권장합니다.

